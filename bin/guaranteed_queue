#!/usr/bin/env ruby

require 'guaranteed_queue/logger'

$0 = "guaranteed_queue"

module GQ
  Logger = GuaranteedQueue::Logger
end

pid_path = "#{Dir.pwd}/tmp/pids/guaranteed_queue.pid"

if ARGV[0] == "stop"
  
  if File.exists? pid_path
    pid = File.read(pid_path)
    %x{kill #{pid}}
    GQ::Logger.info "Killed pid #{pid}"
    FileUtils.rm(pid_path)
  else
    GQ::Logger.info "Not running or no pid"
  end
  exit!
end

# Write pid file to tmp
File.open(pid_path, "w") {|f| f.write($$) }

$LOAD_PATH.push File.dirname(__FILE__) + '/../lib'

begin

  if File.exists? rails_path = "#{Dir.pwd}/config/environment.rb"
    require 'rails'
    GQ::Logger.info "Starting GuaranteedQueue for Rails app in #{Dir.pwd}."
    GQ::Logger.info "Loading application..."
    require rails_path  
    if File.exists? initializer_path = "#{Dir.pwd}/config/initializers/guaranteed_queue.rb"
      GQ::Logger.info "Initializing with guaranteed_queue.rb"
    	require initializer_path
    end
    ::Rails.application.load_tasks
  else
    GQ::Logger.info 'Not running as part of a Rails application.'
  end

  begin
    require 'guaranteed_queue'
  rescue LoadError
    require 'rubygems'
    require 'guaranteed_queue'
  end

  GuaranteedQueue::Manager.run!

rescue SystemExit, Interrupt
  
  GQ::Logger.info "[GuaranteedQueue] Quitting..."
  FileUtils.rm pid_path

end

